<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.9" />
<title>2. Grasp an object: Inverse Geometry</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>2. Grasp an object: Inverse Geometry</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_objectives">Objectives</h2>
<div class="sectionbody">
<div class="paragraph"><p>The main objective of the first tutorial is to compute a configuration of the robot minimizing a cost (maximizing a reward) and respecting some given constraints. Additionally, the objectives are to use a robot model in Pinocchio, optimally the models that were built during the first tutorial, to have a first hands on the difficulties of working outside of real vector spaces and to consider what are the guesses that are taken by an optimal</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial_2_0_technical_prerequisites">Tutorial 2.0. Technical prerequisites</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_python_scipy_and_matplotlib">Python SciPy and MatplotLib</h3>
<div class="paragraph"><p>You will need the two libraries Python <code>SciPy</code> (scientific Python) and <code>MatPlotLib</code> (plot mathematical data).</p></div>
<div class="paragraph"><p>SciPy can be installed by <code>sudo apt-get install python-scipy</code>. It is already installed if you are using the VirtualBox.
Examples of calls of these two functions are given below. We will use both solvers with numerical (finite-differencing) differenciation, to avoid the extra work of differencing the cost and constraint functions by hand. In general, it is strongly advice to first test a numerical program with finite differencing, before implementing the true derivatives only if needed. In any case, the true derivatives must always be checked by comparing the results with the finite differenciation.</p></div>
<div class="paragraph"><p>Additionally, the provided implementation of BFGS allows the user to provide a callback function and track the path taken by the solver, but does not provide the possibility to specify constraints (constraints can be added as penalty functions in the cost, but this requires additional work). The constrained least-square implementation allows the user to specify equality and inequality constraints, but not the callback. In the following, start to use BFGS before moving to the constrained least-square only when constraints are really needed.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Example of use a the optimization toolbox of SciPy.</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> numpy as np
<span style="font-weight: bold"><span style="color: #000080">from</span></span> scipy<span style="color: #990000">.</span>optimize <span style="font-weight: bold"><span style="color: #000080">import</span></span> fmin_bfgs<span style="color: #990000">,</span> fmin_slsqp

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">cost</span></span><span style="color: #990000">(</span>x<span style="color: #990000">):</span>
<span style="font-style: italic"><span style="color: #9A1900">     '''Cost f(x,y) = x^2 + 2y^2 - 2xy - 2x '''</span></span>
     x0 <span style="color: #990000">=</span> x<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span>
     x1 <span style="color: #990000">=</span> x<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span>
     <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">*(</span><span style="color: #993399">2</span><span style="color: #990000">*</span>x0<span style="color: #990000">*</span>x1 <span style="color: #990000">+</span> <span style="color: #993399">2</span><span style="color: #990000">*</span>x0 <span style="color: #990000">-</span> x0<span style="color: #990000">**</span><span style="color: #993399">2</span> <span style="color: #990000">-</span> <span style="color: #993399">2</span><span style="color: #990000">*</span>x1<span style="color: #990000">**</span><span style="color: #993399">2</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">constraint_eq</span></span><span style="color: #990000">(</span>x<span style="color: #990000">):</span>
<span style="font-style: italic"><span style="color: #9A1900">     ''' Constraint x^3 = y '''</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> np<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">array</span></span><span style="color: #990000">([</span> x<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]**</span><span style="color: #993399">3</span><span style="color: #990000">-</span>x<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">constraint_ineq</span></span><span style="color: #990000">(</span>x<span style="color: #990000">):</span>
<span style="font-style: italic"><span style="color: #9A1900">     '''Constraint x&gt;=2, y&gt;=2'''</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> np<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">array</span></span><span style="color: #990000">([</span> x<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]-</span><span style="color: #993399">2</span><span style="color: #990000">,</span>x<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]-</span><span style="color: #993399">2</span> <span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> CallbackLogger<span style="color: #990000">:</span>
     <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
          self<span style="color: #990000">.</span>nfeval <span style="color: #990000">=</span> <span style="color: #993399">1</span>
     <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__call__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>x<span style="color: #990000">):</span>
          <span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">'===CBK=== {0:4d}   {1: 3.6f}   {2: 3.6f}'</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>nfeval<span style="color: #990000">,</span> x<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">],</span> x<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">],</span> <span style="font-weight: bold"><span style="color: #000000">cost</span></span><span style="color: #990000">(</span>x<span style="color: #990000">))</span>
          self<span style="color: #990000">.</span>nfeval <span style="color: #990000">+=</span> <span style="color: #993399">1</span>

x0 <span style="color: #990000">=</span> np<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">array</span></span><span style="color: #990000">([</span><span style="color: #993399">0.0</span><span style="color: #990000">,</span><span style="color: #993399">0.0</span><span style="color: #990000">])</span>
<span style="font-style: italic"><span style="color: #9A1900"># Optimize cost without any constraints in BFGS, with traces.</span></span>
xopt_bfgs <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fmin_bfgs</span></span><span style="color: #990000">(</span>cost<span style="color: #990000">,</span> x0<span style="color: #990000">,</span> callback<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #000000">CallbackLogger</span></span><span style="color: #990000">())</span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">'\n *** Xopt in BFGS = '</span><span style="color: #990000">,</span>xopt_bfgs<span style="color: #990000">,</span><span style="color: #FF0000">'\n\n\n\n'</span>

<span style="font-style: italic"><span style="color: #9A1900"># Optimize cost without any constraints in CLSQ</span></span>
xopt_lsq <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fmin_slsqp</span></span><span style="color: #990000">(</span>cost<span style="color: #990000">,[-</span><span style="color: #993399">1.0</span><span style="color: #990000">,</span><span style="color: #993399">1.0</span><span style="color: #990000">],</span> iprint<span style="color: #990000">=</span><span style="color: #993399">2</span><span style="color: #990000">,</span> full_output<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">'\n *** Xopt in LSQ = '</span><span style="color: #990000">,</span>xopt_lsq<span style="color: #990000">,</span><span style="color: #FF0000">'\n\n\n\n'</span>

<span style="font-style: italic"><span style="color: #9A1900"># Optimize cost with equality and inequality constraints in CLSQ</span></span>
xopt_clsq <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fmin_slsqp</span></span><span style="color: #990000">(</span>cost<span style="color: #990000">,[-</span><span style="color: #993399">1.0</span><span style="color: #990000">,</span><span style="color: #993399">1.0</span><span style="color: #990000">],</span>
                       f_eqcons<span style="color: #990000">=</span>constraint_eq<span style="color: #990000">,</span> f_ieqcons<span style="color: #990000">=</span>constraint_ineq<span style="color: #990000">,</span>
                       iprint<span style="color: #990000">=</span><span style="color: #993399">2</span><span style="color: #990000">,</span> full_output<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">'\n *** Xopt in c-lsq = '</span><span style="color: #990000">,</span>xopt_clsq<span style="color: #990000">,</span><span style="color: #FF0000">'\n\n\n\n'</span></tt></pre></div></div>
<div class="paragraph"><p>Take care that all <code>SciPy</code> always works with vectors represented as 1-dimensional array, while Pinocchio works with vectors represented as matrices (which are in fact two-dimensional arrays, with the second dimension being 1). You can pass from a SciPy-like vector to a Pinocchio-like vector using:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> numpy as np
x <span style="color: #990000">=</span> np<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">array</span></span><span style="color: #990000">([</span> <span style="color: #993399">1.0</span><span style="color: #990000">,</span> <span style="color: #993399">2.0</span><span style="color: #990000">,</span> <span style="color: #993399">3.0</span> <span style="color: #990000">])</span>
q <span style="color: #990000">=</span> np<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">matrix</span></span><span style="color: #990000">(</span>x<span style="color: #990000">).</span>T
x <span style="color: #990000">=</span> q<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getA</span></span><span style="color: #990000">()[:,</span><span style="color: #993399">0</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>The second library <code>MatPlotLib</code> plots values on a 2D graph. Once more, documentation is available here:
<a href="https://www.labri.fr/perso/nrougier/teaching/matplotlib/">https://www.labri.fr/perso/nrougier/teaching/matplotlib/</a>
An example is provided below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> numpy as np
<span style="font-weight: bold"><span style="color: #000080">import</span></span> matplotlib<span style="color: #990000">.</span>pyplot as plt
<span style="font-style: italic"><span style="color: #9A1900"># In plt, the following functions are the most useful:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#    ion,plot,draw,show,subplot,figure,title,savefig</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># For use in interactive python mode (ipthyon -i)</span></span>
interactivePlot <span style="color: #990000">=</span> False

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> interactivePlot<span style="color: #990000">:</span>
    plt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">ion</span></span><span style="color: #990000">()</span> <span style="font-style: italic"><span style="color: #9A1900"># Plot functions now instantaneously display, shell is not blocked</span></span>


<span style="font-style: italic"><span style="color: #9A1900"># Build numpy array for x axis</span></span>
x <span style="color: #990000">=</span> <span style="color: #993399">1e-3</span> <span style="color: #990000">*</span> np<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">array</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">range</span></span> <span style="color: #990000">(</span><span style="color: #993399">100</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900"># Build numpy array for y axis</span></span>
y <span style="color: #990000">=</span> x<span style="color: #990000">**</span><span style="color: #993399">2</span>

fig <span style="color: #990000">=</span> plt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">figure</span></span> <span style="color: #990000">()</span>
ax <span style="color: #990000">=</span> fig<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_subplot</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">'111'</span><span style="color: #990000">)</span>
ax<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">plot</span></span> <span style="color: #990000">(</span>x<span style="color: #990000">,</span> y<span style="color: #990000">)</span>
ax<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">legend</span></span> <span style="color: #990000">((</span><span style="color: #FF0000">"x^2"</span><span style="color: #990000">,))</span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> interactivePlot<span style="color: #990000">:</span>
    <span style="font-style: italic"><span style="color: #9A1900"># Display all the plots and block the shell.</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># The script will only ends when all windows are closed.</span></span>
    plt<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">show</span></span> <span style="color: #990000">()</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_robots">Robots</h3>
<div class="paragraph"><p>We will need two models of robots: one fixed serial-chain manipulator robot with 7-DOF and only simple joints (i.e. having their configuration in a real vector space, e.g. prismatic or revolute); and one mobile "free-floating" robot (i.e. with the first joint being a "JointModelFreeFlyer", with the configuration containing a quaternion).</p></div>
<div class="paragraph"><p>The robot models are assumed to be accessible through two Python classes named RobotFixed for the fixed serial-chain robot, and RobotFloating for the mobile robot. The following operations are supposed to be implemented:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> pinocchio as se3
robot <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">RobotFixed</span></span><span style="color: #990000">()</span>       <span style="font-style: italic"><span style="color: #9A1900"># Possibly set arguments in the constructor.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> robot<span style="color: #990000">.</span>model          <span style="font-style: italic"><span style="color: #9A1900"># Access to the object se3.Model.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> robot<span style="color: #990000">.</span>data           <span style="font-style: italic"><span style="color: #9A1900"># Access to the object se3.Data.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> robot<span style="color: #990000">.</span>viewer         <span style="font-style: italic"><span style="color: #9A1900"># (or robot.display.viewer)  ...</span></span>
                           <span style="font-style: italic"><span style="color: #9A1900"># ... Access to the object gepetto.corbaserver.client.</span></span>
q <span style="color: #990000">=</span> robot<span style="color: #990000">.</span>q0               <span style="font-style: italic"><span style="color: #9A1900"># Access to an arbitrary reference position.</span></span>
robot<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">display</span></span><span style="color: #990000">(</span>q<span style="color: #990000">)</span>           <span style="font-style: italic"><span style="color: #9A1900"># Display the robot in Gepetto-Viewer.</span></span>
i <span style="color: #990000">=</span> robot<span style="color: #990000">.</span>indexEffector    <span style="font-style: italic"><span style="color: #9A1900"># Access to the index of the  (or to one of the) robot effector.</span></span>
se3<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">forwardKinematics</span></span><span style="color: #990000">(</span>robot<span style="color: #990000">.</span>model<span style="color: #990000">,</span>robot<span style="color: #990000">.</span>data<span style="color: #990000">,</span>q<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> robot<span style="color: #990000">.</span>data<span style="color: #990000">.</span>oMi<span style="color: #990000">[</span>i<span style="color: #990000">]</span>    <span style="font-style: italic"><span style="color: #9A1900"># Access to the placement of the end effector at configuration q.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># The three last lines might be embedded in a single method Robot.Mendeffector(q).</span></span></tt></pre></div></div>
<div class="paragraph"><p>These two models are the output of the first tutorial. The most interesting option is to use them.</p></div>
<div class="paragraph"><p>Alternatively, two models are available and are described below. They both implement the rough API described above.</p></div>
<div class="paragraph"><p>UR5 is a fixed robot with one 6-DOF arms developed by the Danish company Universal Robot. All its 6 joints are revolute joints. Its configuration is in R^6 and is not subject to any constraint. The model of UR5 is described in a URDF file, with the visuals of the bodies of the robot being described as meshed (i.e. polygon soups) using the Collada format ".dae". Both the URDF and the DAE files are available in the attached ZIP archive. Uncompressed it in the VirtualBox, for example in the directory "/home/student/src/pinocchio/models".</p></div>
<div class="ulist"><ul>
<li>
<p>
UR5 model and code <a href="ur5.zip"><strong>ur5.zip</strong></a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Then, UR5 might be loaded in Python as a Robot class by the following code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> pinocchio<span style="color: #990000">.</span>robot_wrapper <span style="font-weight: bold"><span style="color: #000080">import</span></span> RobotWrapper
path <span style="color: #990000">=</span> <span style="color: #FF0000">'/home/nmansard/src/pinocchio/pinocchio/models/'</span>
urdf <span style="color: #990000">=</span> path <span style="color: #990000">+</span> <span style="color: #FF0000">'hpp_universal_robot/share/ur_description/urdf/ur5_gripper.urdf'</span>
<span style="font-style: italic"><span style="color: #9A1900"># The robot is loaded with the basis fixed to the world</span></span>
robot <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">RobotWrapper</span></span><span style="color: #990000">(</span>urdf<span style="color: #990000">,[</span>path<span style="color: #990000">,])</span>   <span style="font-style: italic"><span style="color: #9A1900"># Load urdf model</span></span></tt></pre></div></div>
<div class="paragraph"><p>Romeo is a humanoid robot developed by the French-Japanese company Aldebaran Robotics. It has two legs, two arms and a head, for a total of 31 joints (plus 6DOF on the free flyer). Its model is natively in Pinocchio (no additional dowload needed). Romeo can be loaded with:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> pinocchio as se3
<span style="font-weight: bold"><span style="color: #000080">from</span></span> pinocchio<span style="color: #990000">.</span>romeo_wrapper <span style="font-weight: bold"><span style="color: #000080">import</span></span> RomeoWrapper
path <span style="color: #990000">=</span> <span style="color: #FF0000">'/home/nmansard/src/pinocchio/pinocchio/models/romeo/'</span>
urdf <span style="color: #990000">=</span> path <span style="color: #990000">+</span> <span style="color: #FF0000">'urdf/romeo.urdf'</span>
<span style="font-style: italic"><span style="color: #9A1900"># Explicitly specify that the first joint is a free flyer.</span></span>
robot <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">RomeoWrapper</span></span><span style="color: #990000">(</span>urdf<span style="color: #990000">,[</span>path<span style="color: #990000">,],</span>se3<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">JointModelFreeFlyer</span></span><span style="color: #990000">())</span> <span style="font-style: italic"><span style="color: #9A1900"># Load urdf model</span></span>
robot<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initDisplay</span></span><span style="color: #990000">(</span>loadModel<span style="color: #990000">=</span>True<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Additionally, the index of right and left hands and feet are stored in romeo.rh, romeo.lh, romeo.rf and romeo.lf.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial_2_1_position_the_end_effector">Tutorial 2.1. Position the end effector</h2>
<div class="sectionbody">
<div class="paragraph"><p>The first tutorial is to position (i.e. translation only) the end effector of a manipulator robot to a given position. For this first part, we will use the fixed serial-chain robot model.</p></div>
<div class="paragraph"><p>Recall first that the position (3D) of the joint with index "i" at position "q" can be access by the following two lines of code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Compute all joint placements and put the position of joint "i" in variable "p".</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> pinocchio as se3
se3<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">forwardKinematics</span></span><span style="color: #990000">(</span>robot<span style="color: #990000">.</span>model<span style="color: #990000">,</span>robot<span style="color: #990000">.</span>data<span style="color: #990000">,</span>q<span style="color: #990000">)</span>
p <span style="color: #990000">=</span> robot<span style="color: #990000">.</span>data<span style="color: #990000">.</span>oMi<span style="color: #990000">[</span>i<span style="color: #990000">].</span>translation</tt></pre></div></div>
<div class="paragraph"><p><strong>Question 1</strong>
Using this, build a cost function to be the norm of the difference between the end-effector position <code>p</code> and a desired position <code>pdes</code>. The cost function is a function that accepts as input an 1-dimensional array and return a float.</p></div>
<div class="paragraph"><p><strong>Question 2</strong>
Then use <code>fmin_bfgs</code> to find a configuration q with the end effector at position <code>pdes</code>.</p></div>
<div class="paragraph"><p><strong>Question 3</strong>
Finally, implements a callback function that display in Gepetto-Viewer every candidate configuration tried by the solver.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial_2_2_approaching_the_redundancy">Tutorial 2.2. Approaching the redundancy</h2>
<div class="sectionbody">
<div class="paragraph"><p>The manipulator arm has 7 DOF, while the cost function only constraints 3 of them (the position of the end effector). A continuum of solutions then exists. The two next questions are aiming at giving an intuition of this continuum.</p></div>
<div class="paragraph"><p><strong>Question 4</strong>
Sample several configurations respecting <code>pdes</code> by giving various initial guesses to the solver. Store this sampling of solutions in a list, then display this list in Gepetto-Viewer, each configuration begin displayed during 1 second (pause of 1 seconds can be obtained using: import time; time.sleep(1.0)).</p></div>
<div class="paragraph"><p>A configurations in this continuum can then be selected with particular properties, like for example being the closest to a reference configuration, or using some joints more than the others, or any other criterion that you can imagine.</p></div>
<div class="paragraph"><p><strong>Question 5</strong>
Sum a secondary cost term to the first positioning cost, to select the posture that maximizes the similarity (minimizes the norm of the difference) to a reference posture. The relative importance of the two cost terms can be adjusted by weighting the sum: find the weight so that the reference position is obtained with a negligible error (below millimeter) while the posture is properly taken into account.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial_2_3_placing_the_end_effector">Tutorial 2.3. Placing the end-effector</h2>
<div class="sectionbody">
<div class="paragraph"><p>The next step is to find a configuration of the robot so that the end effector respects a reference placement, i.e. position and orientation. The stake is to find a metric in SE(3) to continuously quantify the distance between two placements. There is no canonical metric in SE(3), i.e. no absolute way of weighting the position with respect to the orientation. Two metrics can be considered, namely the log in SE(3) or in R^3 x SE(3). The tutorial will guide you through the first choice.</p></div>
<div class="paragraph"><p>The SE(3) and SO(3) logarithm are implemented in Pinocchio in the explog module.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> pinocchio<span style="color: #990000">.</span>explog <span style="font-weight: bold"><span style="color: #000080">import</span></span> log
<span style="font-weight: bold"><span style="color: #000080">from</span></span> pinocchio <span style="font-weight: bold"><span style="color: #000080">import</span></span> SE3
nu <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>SE3<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Random</span></span><span style="color: #990000">())</span>
nu_vec <span style="color: #990000">=</span> nu<span style="color: #990000">.</span>vector</tt></pre></div></div>
<div class="paragraph"><p><strong>Question 6</strong>
Solve for the configuration that minimizes the norm of the logarithm of the difference between the end effector placement and the desired placement.</p></div>
<div class="paragraph"><p>Optionally, try other metrics, like the log metric of R^3 x SO(3), or the Froebenius norm of the homogeneous matrix.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial_2_4_working_with_a_mobile_robot">Tutorial 2.4. Working with a mobile robot</h2>
<div class="sectionbody">
<div class="paragraph"><p>Until now, the tutorial only worked with a simple manipulator robot, i.e. whose configuration space is a real vector space. Consider now the humanoid robot, whose first joint is a free joint: it has 6 degrees of freedom (3 rotations, 3 translations) but its configuration vector is dimension 7. You can check it with <code>robot.model.nq</code>, that stores the dimension of the configuration, and <code>robot.model.nv</code>, that stores the dimension of the configuration velocity, i.e. the number of degrees of freedom. For the humanoid, nq = nv+1.</p></div>
<div class="paragraph"><p>Indeed, the configuration coefficients 3 to 7 are indeed representing a quaternion. The additional constraint is that these 4 coefficients must be normalize.</p></div>
<div class="paragraph"><p><strong>Question 7</strong>
Display a configuration of the robot for which the norm of the quaternion is bigger than one (e.g. 2.0). What happens?</p></div>
<div class="paragraph"><p>During the search, the solver must respect this constraint. A solution is to make this constraint explicit in the numerical program. However, we will start by an easier quick-and-dirty trick.
With quaternions, the trick is simply to normalize any invalid quaternions. In the cost function, first normalize the quaternion before computing the cost due to the end-effector placement. An additional term should also be added to the cost function to avoid excessive drift of the quaternion norm, in particular with the norm going to 0.</p></div>
<div class="paragraph"><p><strong>Question 8</strong>
Use <code>fmin_bfgs</code> to compute a configuration respecting a given placement with the humanoid model, by normalizing the quaternion at each step.</p></div>
<div class="paragraph"><p><strong>Question 9</strong>
Do the same with the solver C-LSQ <code>fmin_slsqp</code>, with the explicit constraint that the norm of the quaternion must be 1.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2017-01-05 11:38:52 CET
</div>
</div>
</body>
</html>
